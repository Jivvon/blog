#### [채널톡 Meet 서비스] - 내부망 고객사를 위한 WebRTC 전화 서비스 제공

- 배경
    - 내부망을 사용하는 고객사에 WebRTC 전화 서비스를 제공해야 했으나, 스케일링되는 WebRTC 서버의 가변적인 Public IP로 인해 내부망 허용 IP 관리에 어려움이 있었음
    - 고정 IP Pool 관리 방식과 TURN 서버 도입 방식 중, 고정 IP Pool 관리 방식을 채택함
    - 당시 전화 서비스는 채널톡 신규 기능으로 안정화가 좀 더 필요한 단계였는데, 새로운 서버를 도입하는 것과 홉이 늘어나는 것에 대해 회의적이었음
    - 이러한 이유로 특정 대역의 AWS Elastic IP Pool을 확보하고 WebRTC 서버의 InitContainer에서 EIP를 동적으로 할당하도록 구성함
- 기술 부채
    - EIP 할당 과정에서 여러 서버가 동시에 EIP를 가져오는 경우, 할당 가능한 EIP임을 판단하는 시점과 network interface에 할당되는 시점에 시간차가 있기 때문에 분산락과 같은 동시성 문제를 인지하고 있었음
    - 하지만 내부망 고객사의 전화 서비스 이용 시트가 한정적이고, WebRTC 서버가 동시에 2대 이상 스케일 아웃되는 경우가 드물 것으로 예상하여 해당 기술 부채를 안고 가는 전략을 선택
    - 운영 측면에서는 잠재적인 트래픽 급증에 대비하기 위해 스케일링 기준을 완화하고, 이슈 발생 시 즉각적인 인지를 위한 알람을 설정하여 서비스 안정성을 확보함

    - EIP 할당 과정에서 여러 서버가 동시에 EIP를 가져오는 경우, 할당 가능한 EIP임을 판단하는 시점과 network interface에 할당되는 시점에 시간차가 있기 때문에 동시성 문제가 발생할 수 있었음
    - Redis를 활용한 분산 스핀락을 구현하여 EIP 할당부터 유효성 검증까지 전 과정의 안정성을 확보하고, 동시성 문제를 해결함


- ECS -> EKS 마이그레이션
    - ECS에서는 CloudMap과 LB를 혼용해서 사용하다가, EKS로 옮길 땐 LB로 모두 옮긴 후 TargetGroup의 weight를 조절하며 마이그레이션을 수행함
    - DynamoDB Streams로 업데이트하던 인메모리 데이터베이스를 중단 없이 마이그레이션하였습니다
        기존의 무거웠던 AWS Lambda의 역할을 나누었음
        특정 비즈니스 모델을 기준으로 DB를 나누었음
        아래의 순서대로 함
        1. Cloud Map을 사용하던걸 ALB로 옮김
        2. EKS에 인스턴스를 준비하고 DynamoDB Streams를 ECS와 EKS 동시에 흘러들어가도록 함
        3. url path와 Header를 활용하여 내부 특정 채널만을 대상으로 EKS로 마이그레이션된 DB에 대해 테스트함
        4. 모니터링하며 ALB listener rule의 weight를 조절하여 1주에 걸쳐 마이그레이션을 완료함
        DB 컨테이너당 하나의 타입만 지원하는 특성을 고려하여, topologySpreadConstraints로 서로 다른 타입의 컨테이너는 다른 인스턴스에 스케줄링되도록 하여 가용성을 확보함


- whisper spot으로 돌린 썰
    실시간성을 보장하지 않아도 되는 서비스 특성 상 queue에 넣고 모두 spot으로 돌림
    크기가 큰 모델 빠르게 올리기
        spot을 사용하기 때문에 인스턴스 kubelet의 이미지 캐싱을 활용하기에는 어려웠음
        볼륨 스냅샷을 활용해서 인스턴스 프로비저닝시 마운트하는 방법 (disk iops or network bandwidth)
        모델이 포함된 AMI 빌드해서 사용
    동일한 기능을 제공하는 Saas보다 훨씬 적은 비용으로 운영 중
